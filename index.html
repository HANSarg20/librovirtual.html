<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Virtual</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/lucide.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- PDF.js de Mozilla -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

    <style>
        :root {
            /* Paleta de colores inspirada en el diseño de referencia */
            --background-main: #101d21;
            --background-card: #1a2a2f;
            --accent-primary: #1ed760;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #2a3f44;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-main);
            color: var(--text-primary);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--background-main); 
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 8px;
        }
        
        .section-title {
            @apply text-2xl font-bold text-text-primary mb-4;
        }

        .book-card {
            @apply bg-background-card p-4 rounded-lg cursor-pointer transition-transform duration-200 hover:scale-105 flex flex-col;
        }
        
        .book-cover-placeholder {
            @apply w-full h-40 bg-gray-700 rounded-md mb-3 flex items-center justify-center text-center p-2;
        }

        .control-btn {
            @apply p-2 bg-gray-700 rounded-full text-text-secondary hover:bg-accent-primary hover:text-white transition-all duration-200 focus:outline-none;
        }
        
        .reader-view {
            @apply fixed inset-0 z-50 bg-background-main flex flex-col transition-opacity duration-300;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Vista Principal de la Biblioteca (Feed) -->
    <main id="libraryFeed" class="p-4 md:p-6">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Para ti</h1>
            <button id="addBookBtn" class="bg-accent-primary text-background-main font-bold py-2 px-5 rounded-full hover:opacity-90 transition-all flex items-center">
                <i data-lucide="plus" class="mr-1 h-5 w-5"></i>Añadir
            </button>
            <input type="file" id="fileInput" class="hidden" accept=".txt,.pdf">
        </header>

        <!-- Sección Mi Biblioteca -->
        <section id="myLibrarySection" class="mb-10">
            <h2 class="section-title">Mi Biblioteca</h2>
            <div id="bookList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- Los libros del usuario se insertarán aquí -->
            </div>
        </section>

        <!-- Sección Biblioteca Pública -->
        <section id="publicLibrarySection">
            <h2 class="section-title">Biblioteca Pública</h2>
            <div id="publicLibraryContent" class="space-y-8">
                <!-- Las categorías y libros públicos se insertarán aquí -->
            </div>
        </section>
    </main>

    <!-- Vista del Lector (Inicialmente oculta) -->
    <div id="contentViewer" class="reader-view hidden">
        <!-- Cabecera del Lector -->
        <header class="flex-shrink-0 p-4 flex items-center justify-between border-b border-border-color">
            <button id="closeReaderBtn" class="p-2 rounded-full hover:bg-gray-800">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 id="bookTitle" class="text-xl font-bold text-white truncate w-3/4 text-center"></h2>
            <div class="w-10"></div> <!-- Espaciador -->
        </header>

        <!-- Controles y Contenido -->
        <div class="flex-grow p-4 md:p-6 flex flex-col overflow-hidden">
            <div id="controls" class="flex-shrink-0 bg-background-card p-3 rounded-lg mb-4 flex flex-wrap items-center gap-4 justify-between border border-border-color">
                <div class="flex items-center gap-3">
                    <button id="summarizeBtn" title="Resumir con IA" class="control-btn"><i data-lucide="brain-circuit"></i></button>
                    <button id="playBtn" title="Reproducir" class="control-btn"><i data-lucide="play"></i></button>
                    <button id="pauseBtn" title="Pausar" class="control-btn hidden"><i data-lucide="pause"></i></button>
                    <button id="stopBtn" title="Detener" class="control-btn"><i data-lucide="stop-circle"></i></button>
                </div>
                <div class="flex items-center gap-4">
                    <select id="voiceSelect" class="bg-gray-800 text-white rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent-primary"></select>
                    <div class="flex items-center gap-2 text-sm">
                        <i data-lucide="gauge-circle"></i>
                        <input id="speedRange" type="range" min="0.5" max="2" step="0.1" value="1" class="w-24 cursor-pointer">
                        <span id="speedValue" class="w-10 text-center">1.0x</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="deleteBookBtn" title="Eliminar Libro" class="control-btn"><i data-lucide="trash-2"></i></button>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto bg-background-card p-6 rounded-lg relative border border-border-color">
                <div id="loadingOverlay" class="hidden absolute inset-0 bg-background-card bg-opacity-80 flex flex-col items-center justify-center z-10">
                    <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-4 text-lg font-semibold">Procesando...</p>
                </div>
                <button id="showOriginalBtn" class="hidden mb-4 text-sm text-accent-primary hover:opacity-80 transition-all">&larr; Volver al texto original</button>
                <p id="textContent" class="text-text-secondary text-lg leading-relaxed whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-accent-primary text-background-main font-semibold py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300"></div>

    <script>
        const publicLibrary = {
            "Ciencia de la Computación": [{ title: "Algoritmos Fundamentales", content: `Un algoritmo es una secuencia de instrucciones para resolver un problema...` }, { title: "Introducción a Redes (OSI)", content: `Una red conecta dispositivos para compartir recursos...` }],
            "Física": [{ title: "Leyes del Movimiento de Newton", content: `1. Inercia: Un objeto permanece en su estado de movimiento... 2. Fuerza: F = ma... 3. Acción-Reacción: Para cada acción, hay una reacción igual y opuesta.` }],
            "Química": [{ title: "El Átomo y sus Partículas", content: `El átomo es la unidad básica de un elemento. Contiene un núcleo con protones (+), neutrones, y electrones (-) que lo orbitan.` }],
            "Álgebra": [{ title: "Fórmula Cuadrática", content: `Para resolver ax² + bx + c = 0. La solución es x = [-b ± sqrt(b²-4ac)] / 2a.` }],
            "Geometría": [{ title: "Teorema de Pitágoras", content: `En un triángulo rectángulo, a² + b² = c².` }],
            "Aritmética": [{ title: "Operaciones Básicas", content: `Estudia la suma, resta, multiplicación y división.` }],
            "Trigonometría": [{ title: "Funciones Trigonométricas", content: `Estudia las relaciones entre ángulos y lados. Funciones principales: Seno, Coseno, Tangente.` }]
        };

        function initializeApp() {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.js`;

            // Vistas
            const libraryFeed = document.getElementById('libraryFeed');
            const contentViewer = document.getElementById('contentViewer');
            
            // Contenedores de listas
            const bookListContainer = document.getElementById('bookList');
            const publicLibraryContainer = document.getElementById('publicLibraryContent');

            // Botones principales
            const addBookBtn = document.getElementById('addBookBtn');
            const fileInput = document.getElementById('fileInput');
            const closeReaderBtn = document.getElementById('closeReaderBtn');

            // Elementos del lector
            const bookTitle = document.getElementById('bookTitle');
            const textContent = document.getElementById('textContent');
            const summarizeBtn = document.getElementById('summarizeBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const showOriginalBtn = document.getElementById('showOriginalBtn');
            const deleteBookBtn = document.getElementById('deleteBookBtn');

            // Controles de audio
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            const voiceSelect = document.getElementById('voiceSelect');
            const speedRange = document.getElementById('speedRange');
            const speedValue = document.getElementById('speedValue');
            const toast = document.getElementById('toast');

            let userLibrary = [];
            let currentBook = { id: null, source: null, title: '', content: '' };
            let isSpeaking = false;
            let utterance = null;
            let voices = [];

            function init() {
                loadUserLibrary();
                renderUserBookList();
                renderPublicLibrary();
                setupEventListeners();
                lucide.createIcons();
                populateVoiceList();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = populateVoiceList;
                }
            }

            function createBookCard(book) {
                const card = document.createElement('div');
                card.className = 'book-card';
                card.innerHTML = `
                    <div class="book-cover-placeholder">
                        <i data-lucide="book-marked" class="w-12 h-12 text-gray-500"></i>
                    </div>
                    <h4 class="font-semibold truncate">${book.title}</h4>
                    <p class="text-sm text-text-secondary">${book.source === 'user' ? 'Personal' : 'Público'}</p>
                `;
                card.addEventListener('click', () => showReader(book));
                return card;
            }

            function renderUserBookList() {
                bookListContainer.innerHTML = '';
                if (userLibrary.length === 0) {
                    bookListContainer.innerHTML = `<p class="text-text-secondary col-span-full">Tu biblioteca está vacía. Añade un libro para empezar.</p>`;
                    document.getElementById('myLibrarySection').classList.add('hidden');
                } else {
                    document.getElementById('myLibrarySection').classList.remove('hidden');
                    userLibrary.forEach(book => {
                        const card = createBookCard(book);
                        bookListContainer.appendChild(card);
                    });
                }
                lucide.createIcons();
            }

            function renderPublicLibrary() {
                publicLibraryContainer.innerHTML = '';
                for (const category in publicLibrary) {
                    const categorySection = document.createElement('div');
                    let booksHTML = '';
                    publicLibrary[category].forEach((bookData, index) => {
                        const book = { ...bookData, id: `${category.replace(/\s+/g, '_')}-${index}`, source: 'public' };
                        const card = createBookCard(book);
                        booksHTML += card.outerHTML;
                    });
                    categorySection.innerHTML = `
                        <h3 class="text-xl font-bold mb-3">${category}</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">${booksHTML}</div>
                    `;
                    publicLibraryContainer.appendChild(categorySection);
                }
                // Re-asignar eventos porque outerHTML rompe las referencias
                publicLibraryContainer.querySelectorAll('.book-card').forEach(cardElement => {
                    cardElement.addEventListener('click', () => {
                        const [categoryKey, index] = cardElement.dataset.id.split(/-(?=\d+$)/);
                        const categoryName = categoryKey.replace(/_/g, ' ');
                        const bookData = publicLibrary[categoryName][index];
                        const book = { ...bookData, id: cardElement.dataset.id, source: 'public' };
                        showReader(book);
                    });
                });

                lucide.createIcons();
            }

            function loadUserLibrary() {
                const savedLibrary = localStorage.getItem('virtualLibraryDB_v2');
                userLibrary = savedLibrary ? JSON.parse(savedLibrary) : [];
                userLibrary.forEach(book => book.source = 'user'); // Asegurar fuente
            }

            function saveUserLibrary() {
                localStorage.setItem('virtualLibraryDB_v2', JSON.stringify(userLibrary));
            }

            async function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                loadingOverlay.classList.remove('hidden');
                try {
                    const title = file.name.replace(/\.(txt|pdf)$/i, '');
                    let content = '';
                    if (file.type === "text/plain") {
                        content = await file.text();
                    } else if (file.type === "application/pdf") {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            content += textContent.items.map(item => item.str).join(' ') + '\n\n';
                        }
                    } else {
                        throw new Error("Formato no soportado.");
                    }
                    addBookToLibrary(title, content.trim());
                } catch (error) {
                    showToast(error.message, "error");
                } finally {
                    loadingOverlay.classList.add('hidden');
                    fileInput.value = '';
                }
            }

            function addBookToLibrary(title, content) {
                const newBook = { id: Date.now(), title, content, source: 'user' };
                userLibrary.push(newBook);
                saveUserLibrary();
                renderUserBookList();
                showToast("Libro añadido con éxito");
            }

            function showReader(book) {
                currentBook = book;
                bookTitle.textContent = book.title;
                textContent.textContent = book.content;
                deleteBookBtn.style.display = book.source === 'user' ? 'block' : 'none';
                showOriginalBtn.classList.add('hidden');
                stopSpeech();
                
                libraryFeed.classList.add('hidden');
                contentViewer.classList.remove('hidden');
            }

            function closeReader() {
                libraryFeed.classList.remove('hidden');
                contentViewer.classList.add('hidden');
                currentBook = { id: null, source: null, title: '', content: '' };
                stopSpeech();
            }

            function deleteCurrentBook() {
                if (!currentBook.id || currentBook.source !== 'user') return;
                if (confirm(`¿Confirmas la eliminación de "${currentBook.title}"?`)) {
                    userLibrary = userLibrary.filter(b => b.id !== currentBook.id);
                    saveUserLibrary();
                    renderUserBookList();
                    closeReader();
                    showToast("Libro eliminado");
                }
            }

            // ... (El resto de funciones como summarizeText, playSpeech, etc. se mantienen igual, pero se adaptan al nuevo flujo)
            async function summarizeText() {
                if (!currentBook.id) return;
                loadingOverlay.classList.remove('hidden');
                summarizeBtn.disabled = true;
                try {
                    const prompt = `Resume el siguiente texto de forma clara y concisa en español:\n\n---\n\n${currentBook.content}`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        textContent.textContent = result.candidates[0].content.parts[0].text;
                        showOriginalBtn.classList.remove('hidden');
                    } else { throw new Error("Respuesta de API no válida."); }
                } catch (error) { textContent.textContent = "Error al generar el resumen."; }
                finally { loadingOverlay.classList.add('hidden'); summarizeBtn.disabled = false; }
            }
            
            function populateVoiceList() {
                voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('es'));
                voiceSelect.innerHTML = voices.length ? '' : '<option>No hay voces en español</option>';
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-name', voice.name);
                    voiceSelect.appendChild(option);
                });
            }

            function playSpeech() {
                if (speechSynthesis.speaking) { speechSynthesis.resume(); isSpeaking = true; updatePlayPauseButtons(); return; }
                utterance = new SpeechSynthesisUtterance(textContent.textContent);
                const selectedVoice = voices.find(v => v.name === voiceSelect.selectedOptions[0]?.dataset.name);
                if (selectedVoice) utterance.voice = selectedVoice;
                utterance.rate = parseFloat(speedRange.value);
                utterance.onstart = () => { isSpeaking = true; updatePlayPauseButtons(); };
                utterance.onend = () => { isSpeaking = false; updatePlayPauseButtons(); };
                utterance.onerror = () => { isSpeaking = false; updatePlayPauseButtons(); showToast("Error al reproducir audio.", "error"); };
                speechSynthesis.speak(utterance);
            }

            function pauseSpeech() { speechSynthesis.pause(); isSpeaking = false; updatePlayPauseButtons(); }
            function stopSpeech() { speechSynthesis.cancel(); isSpeaking = false; updatePlayPauseButtons(); }
            function updatePlayPauseButtons() { playBtn.classList.toggle('hidden', isSpeaking); pauseBtn.classList.toggle('hidden', !isSpeaking); }
            
            function showToast(message, type = 'success') {
                toast.textContent = message;
                toast.style.backgroundColor = type === 'success' ? 'var(--accent-primary)' : '#ef4444';
                toast.style.color = type === 'success' ? 'var(--background-main)' : '#ffffff';
                toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
            }

            function setupEventListeners() {
                addBookBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileUpload);
                closeReaderBtn.addEventListener('click', closeReader);
                summarizeBtn.addEventListener('click', summarizeText);
                showOriginalBtn.addEventListener('click', () => {
                    textContent.textContent = currentBook.content;
                    showOriginalBtn.classList.add('hidden');
                });
                deleteBookBtn.addEventListener('click', deleteCurrentBook);
                playBtn.addEventListener('click', playSpeech);
                pauseBtn.addEventListener('click', pauseSpeech);
                stopBtn.addEventListener('click', stopSpeech);
                speedRange.addEventListener('input', e => {
                    const speed = parseFloat(e.target.value).toFixed(1);
                    speedValue.textContent = `${speed}x`;
                    if (isSpeaking) { utterance.rate = speed; }
                });
            }

            init();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const waitForLibraries = () => {
                if (window.pdfjsLib && window.lucide) {
                    initializeApp();
                } else {
                    setTimeout(waitForLibraries, 100);
                }
            };
            waitForLibraries();
        });
    </script>
</body>
</html>
