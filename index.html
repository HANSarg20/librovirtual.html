<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Virtual Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/lucide.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- PDF.js de Mozilla -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

    <style>
        :root {
            --background-main: #101d21;
            --background-card: #1a2a2f;
            --accent-primary: #1ed760;
            --accent-secondary: #2a3f44;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #2a3f44;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-main);
            color: var(--text-primary);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--background-main); }
        ::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 8px; }
        
        .section-title { @apply text-2xl font-bold text-text-primary mb-4; }
        .book-card { @apply bg-background-card p-4 rounded-lg transition-transform duration-200 hover:scale-105 flex flex-col relative; }
        .book-cover-placeholder { @apply w-full h-40 bg-gray-700 rounded-md mb-3 flex items-center justify-center text-center p-2; }
        .control-btn { @apply p-2 bg-gray-700 rounded-full text-text-secondary hover:bg-accent-primary hover:text-white transition-all duration-200 focus:outline-none; }
        .reader-view { @apply fixed inset-0 z-50 bg-background-main flex flex-col transition-transform duration-300 ease-in-out; }
        .favorite-btn { @apply absolute top-2 right-2 p-2 rounded-full bg-black/30 text-white hover:text-red-500 transition-colors; }
        .favorite-btn.favorited { @apply text-red-500; }
    </style>
</head>
<body class="antialiased">

    <!-- Vista Principal de la Biblioteca (Feed) -->
    <main id="library-view" class="p-4 md:p-6">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-3xl font-extrabold">Para ti</h1>
            <div class="w-full sm:w-1/2 lg:w-1/3">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary"></i>
                    <input type="text" id="searchInput" placeholder="Buscar en la biblioteca..." class="w-full bg-accent-secondary pl-10 pr-4 py-2 rounded-full focus:outline-none focus:ring-2 focus:ring-accent-primary">
                </div>
            </div>
            <button id="addBookBtn" class="bg-accent-primary text-background-main font-bold py-2 px-5 rounded-full hover:opacity-90 transition-all flex items-center">
                <i data-lucide="plus" class="mr-1 h-5 w-5"></i>Añadir
            </button>
            <input type="file" id="fileInput" class="hidden" accept=".txt,.pdf">
        </header>

        <div id="feed-content">
            <!-- Las secciones (Favoritos, Mi Biblioteca, Pública) se renderizarán aquí -->
        </div>
    </main>

    <!-- Vista del Lector (Inicialmente oculta) -->
    <div id="reader-view" class="reader-view translate-x-full">
        <!-- Contenido del lector aquí -->
    </div>

    <!-- Plantillas para clonar (más eficiente que innerHTML para eventos) -->
    <template id="reader-template">
        <header class="flex-shrink-0 p-4 flex items-center justify-between border-b border-border-color">
            <button class="p-2 rounded-full hover:bg-gray-800 close-reader-btn">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="book-title text-xl font-bold text-white truncate w-3/4 text-center"></h2>
            <div class="w-10"></div>
        </header>
        <div class="flex-grow p-4 md:p-6 flex flex-col overflow-hidden">
            <div class="flex-shrink-0 bg-background-card p-3 rounded-lg mb-4 flex flex-wrap items-center gap-4 justify-between border border-border-color">
                <div class="flex items-center gap-3">
                    <button title="Resumir con IA" class="control-btn summarize-btn"><i data-lucide="brain-circuit"></i></button>
                    <button title="Reproducir" class="control-btn play-btn"><i data-lucide="play"></i></button>
                    <button title="Pausar" class="control-btn pause-btn hidden"><i data-lucide="pause"></i></button>
                    <button title="Detener" class="control-btn stop-btn"><i data-lucide="stop-circle"></i></button>
                </div>
                <div class="flex items-center gap-4">
                    <select class="voice-select bg-gray-800 text-white rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent-primary"></select>
                    <div class="flex items-center gap-2 text-sm">
                        <i data-lucide="gauge-circle"></i>
                        <input type="range" min="0.5" max="2" step="0.1" value="1" class="speed-range w-24 cursor-pointer">
                        <span class="speed-value w-10 text-center">1.0x</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button title="Eliminar Libro" class="control-btn delete-book-btn"><i data-lucide="trash-2"></i></button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto bg-background-card p-6 rounded-lg relative border border-border-color">
                <div class="loading-overlay hidden absolute inset-0 bg-background-card bg-opacity-80 flex flex-col items-center justify-center z-10">
                    <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-4 text-lg font-semibold">Procesando...</p>
                </div>
                <button class="show-original-btn hidden mb-4 text-sm text-accent-primary hover:opacity-80 transition-all">&larr; Volver al texto original</button>
                <p class="text-content text-text-secondary text-lg leading-relaxed whitespace-pre-wrap"></p>
            </div>
        </div>
    </template>

    <div id="toast" class="fixed bottom-5 right-5 bg-accent-primary text-background-main font-semibold py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300"></div>

    <script>
        const publicLibraryData = {
            "Ciencia de la Computación": [{ title: "Algoritmos Fundamentales", content: `Un algoritmo es una secuencia de instrucciones para resolver un problema...` }, { title: "Introducción a Redes (OSI)", content: `Una red conecta dispositivos para compartir recursos...` }],
            "Física": [{ title: "Leyes del Movimiento de Newton", content: `1. Inercia... 2. Fuerza: F=ma... 3. Acción-Reacción...` }],
            "Química": [{ title: "El Átomo y sus Partículas", content: `El átomo es la unidad básica de un elemento...` }],
            "Álgebra": [{ title: "Fórmula Cuadrática", content: `Para resolver ax² + bx + c = 0...` }],
            "Geometría": [{ title: "Teorema de Pitágoras", content: `En un triángulo rectángulo, a² + b² = c².` }],
            "Aritmética": [{ title: "Operaciones Básicas", content: `Estudia la suma, resta, multiplicación y división.` }],
            "Trigonometría": [{ title: "Funciones Trigonométricas", content: `Estudia las relaciones entre ángulos y lados...` }]
        };

        function initializeApp() {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.js`;

            const appState = {
                userLibrary: [],
                favorites: [],
                searchQuery: '',
                currentBook: null,
                isSpeaking: false,
                utterance: null,
                voices: []
            };

            const bookMap = {};

            const dom = {
                libraryView: document.getElementById('library-view'),
                readerView: document.getElementById('reader-view'),
                feedContent: document.getElementById('feed-content'),
                addBookBtn: document.getElementById('addBookBtn'),
                fileInput: document.getElementById('fileInput'),
                searchInput: document.getElementById('searchInput'),
                readerTemplate: document.getElementById('reader-template'),
                toast: document.getElementById('toast')
            };

            function init() {
                buildBookMap();
                loadState();
                renderFeed();
                setupEventListeners();
                lucide.createIcons();
                populateVoiceList();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = populateVoiceList;
                }
            }

            function buildBookMap() {
                Object.keys(publicLibraryData).forEach(category => {
                    publicLibraryData[category].forEach((bookData, index) => {
                        const id = `public_${category.replace(/\s+/g, '_')}_${index}`;
                        bookMap[id] = { ...bookData, id, source: 'public' };
                    });
                });
            }

            function loadState() {
                const savedLibrary = JSON.parse(localStorage.getItem('virtualLibrary_user')) || [];
                const savedFavorites = JSON.parse(localStorage.getItem('virtualLibrary_favorites')) || [];
                appState.userLibrary = savedLibrary;
                appState.favorites = savedFavorites;
                appState.userLibrary.forEach(book => { bookMap[book.id] = book; });
            }

            function saveState() {
                localStorage.setItem('virtualLibrary_user', JSON.stringify(appState.userLibrary));
                localStorage.setItem('virtualLibrary_favorites', JSON.stringify(appState.favorites));
            }

            function createBookCard(book) {
                const isFavorited = appState.favorites.includes(book.id);
                return `
                    <div class="book-card" data-id="${book.id}">
                        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-id="${book.id}">
                            <i data-lucide="heart" class="${isFavorited ? 'fill-current' : ''}"></i>
                        </button>
                        <div class="book-cover-placeholder">
                            <i data-lucide="book-marked" class="w-12 h-12 text-gray-500"></i>
                        </div>
                        <h4 class="font-semibold truncate mt-auto pt-2">${book.title}</h4>
                    </div>
                `;
            }

            function renderFeed() {
                const query = appState.searchQuery.toLowerCase();
                const allBooks = Object.values(bookMap);
                const filteredBooks = query ? allBooks.filter(b => b.title.toLowerCase().includes(query)) : allBooks;
                
                let feedHTML = '';

                // Favoritos
                const favoriteBooks = appState.favorites.map(id => bookMap[id]).filter(Boolean);
                if (favoriteBooks.length > 0) {
                    feedHTML += `<section id="favoritesSection" class="mb-10">
                        <h2 class="section-title">Favoritos</h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">${favoriteBooks.map(createBookCard).join('')}</div>
                    </section>`;
                }

                // Mi Biblioteca
                const userBooks = appState.userLibrary.filter(b => filteredBooks.includes(b));
                if (userBooks.length > 0) {
                     feedHTML += `<section id="myLibrarySection" class="mb-10">
                        <h2 class="section-title">Mi Biblioteca</h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">${userBooks.map(createBookCard).join('')}</div>
                    </section>`;
                }

                // Biblioteca Pública
                feedHTML += `<section id="publicLibrarySection"><h2 class="section-title">Biblioteca Pública</h2><div class="space-y-8">`;
                for (const category in publicLibraryData) {
                    const categoryBooks = publicLibraryData[category]
                        .map((book, index) => bookMap[`public_${category.replace(/\s+/g, '_')}_${index}`])
                        .filter(b => filteredBooks.includes(b));

                    if (categoryBooks.length > 0) {
                        feedHTML += `
                            <div>
                                <h3 class="text-xl font-bold mb-3">${category}</h3>
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">${categoryBooks.map(createBookCard).join('')}</div>
                            </div>
                        `;
                    }
                }
                feedHTML += `</div></section>`;
                
                dom.feedContent.innerHTML = feedHTML;
                lucide.createIcons();
            }

            async function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                showReader(null, true); // Mostrar lector con overlay de carga
                
                try {
                    const title = file.name.replace(/\.(txt|pdf)$/i, '');
                    let content = '';
                    if (file.type === "text/plain") {
                        content = await file.text();
                    } else if (file.type === "application/pdf") {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            content += textContent.items.map(item => item.str).join(' ') + '\n\n';
                        }
                    } else { throw new Error("Formato no soportado."); }
                    
                    const newBook = { id: `user_${Date.now()}`, title, content: content.trim(), source: 'user' };
                    appState.userLibrary.push(newBook);
                    bookMap[newBook.id] = newBook;
                    saveState();
                    renderFeed();
                    showToast("Libro añadido con éxito");
                } catch (error) {
                    showToast(error.message, "error");
                } finally {
                    closeReader();
                }
            }

            function showReader(book, isLoading = false) {
                appState.currentBook = book;
                const readerContent = dom.readerTemplate.content.cloneNode(true);
                dom.readerView.innerHTML = '';
                dom.readerView.appendChild(readerContent);

                const reader = {
                    title: dom.readerView.querySelector('.book-title'),
                    content: dom.readerView.querySelector('.text-content'),
                    loading: dom.readerView.querySelector('.loading-overlay'),
                    deleteBtn: dom.readerView.querySelector('.delete-book-btn'),
                    originalBtn: dom.readerView.querySelector('.show-original-btn'),
                    summarizeBtn: dom.readerView.querySelector('.summarize-btn'),
                    playBtn: dom.readerView.querySelector('.play-btn'),
                    pauseBtn: dom.readerView.querySelector('.pause-btn'),
                    stopBtn: dom.readerView.querySelector('.stop-btn'),
                    voiceSelect: dom.readerView.querySelector('.voice-select'),
                    speedRange: dom.readerView.querySelector('.speed-range'),
                    speedValue: dom.readerView.querySelector('.speed-value'),
                };

                if (isLoading) {
                    reader.loading.classList.remove('hidden');
                } else {
                    reader.title.textContent = book.title;
                    reader.content.textContent = book.content;
                    reader.deleteBtn.style.display = book.source === 'user' ? 'flex' : 'none';
                }
                
                // Re-populate and set up controls
                appState.voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-name', voice.name);
                    reader.voiceSelect.appendChild(option);
                });
                
                dom.readerView.classList.remove('translate-x-full');
                lucide.createIcons();
            }

            function closeReader() {
                dom.readerView.classList.add('translate-x-full');
                stopSpeech();
                appState.currentBook = null;
            }

            function deleteCurrentBook() {
                const book = appState.currentBook;
                if (!book || book.source !== 'user') return;
                if (confirm(`¿Confirmas la eliminación de "${book.title}"?`)) {
                    appState.userLibrary = appState.userLibrary.filter(b => b.id !== book.id);
                    appState.favorites = appState.favorites.filter(id => id !== book.id);
                    delete bookMap[book.id];
                    saveState();
                    renderFeed();
                    closeReader();
                    showToast("Libro eliminado");
                }
            }
            
            function toggleFavorite(bookId) {
                const index = appState.favorites.indexOf(bookId);
                if (index > -1) {
                    appState.favorites.splice(index, 1);
                } else {
                    appState.favorites.push(bookId);
                }
                saveState();
                renderFeed();
            }

            // --- Lógica de IA y Audio (simplificada para brevedad) ---
            async function summarizeText() { /* ... */ }
            function populateVoiceList() { appState.voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es')); }
            function playSpeech() { /* ... */ }
            function pauseSpeech() { /* ... */ }
            function stopSpeech() { if(speechSynthesis.speaking) speechSynthesis.cancel(); appState.isSpeaking = false; }
            
            function showToast(message, type = 'success') {
                dom.toast.textContent = message;
                dom.toast.style.backgroundColor = type === 'success' ? 'var(--accent-primary)' : '#ef4444';
                dom.toast.style.color = type === 'success' ? 'var(--background-main)' : '#ffffff';
                dom.toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => { dom.toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
            }

            function setupEventListeners() {
                dom.addBookBtn.addEventListener('click', () => dom.fileInput.click());
                dom.fileInput.addEventListener('change', handleFileUpload);
                dom.searchInput.addEventListener('input', (e) => {
                    appState.searchQuery = e.target.value;
                    renderFeed();
                });

                // Event Delegation para toda la app
                document.body.addEventListener('click', (e) => {
                    const card = e.target.closest('.book-card');
                    const favBtn = e.target.closest('.favorite-btn');
                    const closeBtn = e.target.closest('.close-reader-btn');
                    const deleteBtn = e.target.closest('.delete-book-btn');
                    const summarizeBtn = e.target.closest('.summarize-btn');
                    // ... otros botones del lector ...

                    if (favBtn) {
                        e.stopPropagation(); // Evitar que abra el libro
                        toggleFavorite(favBtn.dataset.id);
                    } else if (card) {
                        showReader(bookMap[card.dataset.id]);
                    } else if (closeBtn) {
                        closeReader();
                    } else if (deleteBtn) {
                        deleteCurrentBook();
                    } else if (summarizeBtn) {
                        // Implementar summarizeText
                    }
                });
            }

            init();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const waitForLibraries = () => {
                if (window.pdfjsLib && window.lucide) {
                    initializeApp();
                } else {
                    setTimeout(waitForLibraries, 100);
                }
            };
            waitForLibraries();
        });
    </script>
</body>
</html>
